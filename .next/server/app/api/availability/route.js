(()=>{var e={};e.id=325,e.ids=[325],e.modules={399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3292:e=>{"use strict";e.exports=require("fs/promises")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},6005:e=>{"use strict";e.exports=require("node:crypto")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},1825:()=>{},8919:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>h,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>c,dynamic:()=>l});var i=r(9303),n=r(8716),s=r(670),o=r(7070),u=r(7904);let l="force-dynamic";async function c(e){let{searchParams:t}=new URL(e.url),r=t.get("chalet")||"C1",a=r=r.trim().toUpperCase();("DUO"===r||"SPA"===r)&&(a="C2");let i=t.get("from"),n=t.get("to");console.log("[availability] chalet =",a,"(raw =",r+")");let s=await (0,u.Y)(a),l=await (0,u.o)(a);console.log("[availability] siteRes count =",l.length,"ext bookedDates count =",(s.bookedDates||[]).length);let c=new Set;for(let e of l){let t=new Date(e.checkIn);t.setHours(12,0,0,0);let r=new Date(e.checkOut);r.setHours(12,0,0,0);for(let e=new Date(t);e<r;e.setDate(e.getDate()+1))c.add(function(e){let t=new Date(e);return t.setHours(12,0,0,0),t.toISOString().slice(0,10)}(e))}let d=new Set(s.bookedDates||[]);for(let e of c)d.add(e);let p=i?new Date(i):new Date,f=new Date(n||Date.now()+31536e6);p.setHours(12,0,0,0),f.setHours(12,0,0,0);let w=Array.from(d).filter(e=>{let t=new Date(e);return t.setHours(12,0,0,0),t>=p&&t<=f}).sort();return console.log("[availability] final bookedDates count =",w.length),o.NextResponse.json({chalet:a,bookedDates:w,ranges:s.ranges,updatedAt:s.updatedAt,nextRefreshInMin:15})}let d=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/availability/route",pathname:"/api/availability",filename:"route",bundlePath:"app/api/availability/route"},resolvedPagePath:"C:\\Users\\Nina\\Downloads\\ty-koad-v5_1\\ty-koad-demo-v5.1\\app\\api\\availability\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:w}=d,y="/api/availability/route";function h(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},8847:(e,t,r)=>{"use strict";r.d(t,{$:()=>m,KQ:()=>p,bA:()=>w,iD:()=>f,iE:()=>y,k3:()=>v,v6:()=>h});var a=r(3292),i=r.n(a),n=r(1017),s=r.n(n);let o=s().join(process.cwd(),"data"),u=s().join(o,"reservations.json"),l=s().join(o,"config.json"),c=s().join(o,"vouchers.json");async function d(){await i().mkdir(o,{recursive:!0});try{await i().access(u)}catch{await i().writeFile(u,"[]","utf-8")}try{await i().access(l)}catch{await i().writeFile(l,JSON.stringify({icalC1:"",icalC2:""},null,2),"utf-8")}try{await i().access(c)}catch{await i().writeFile(c,"[]","utf-8")}}async function p(){return await d(),JSON.parse(await i().readFile(u,"utf-8")||"[]")}async function f(e){await d();let t=await p();return t.unshift({...e,createdAt:new Date().toISOString()}),await i().writeFile(u,JSON.stringify(t,null,2),"utf-8"),{ok:!0}}async function w({paymentIntentId:e,...t}){await d();let r=await p(),a=r.findIndex(t=>t.paymentIntentId===e);return a>=0&&(r[a]={...r[a],...t}),await i().writeFile(u,JSON.stringify(r,null,2),"utf-8"),{ok:!0}}async function y(){return await d(),JSON.parse(await i().readFile(l,"utf-8")||"{}")}async function h(e){let t={...await y(),...e};return await i().writeFile(l,JSON.stringify(t,null,2),"utf-8"),t}let g=async()=>(await d(),JSON.parse(await i().readFile(c,"utf-8")||"[]")),D=async e=>i().writeFile(c,JSON.stringify(e,null,2),"utf-8");async function m(e){let t=await g();if(t.some(t=>t.code===e.code))throw Error("Code d\xe9j\xe0 existant");return t.unshift({...e,createdAt:new Date().toISOString(),status:"active",redemptions:[]}),await D(t),e}async function v(e){return(await g()).find(t=>t.stripeSessionId===e)||null}},7904:(e,t,r)=>{"use strict";r.d(t,{Y:()=>u,o:()=>l});var a=r(3934),i=r.n(a),n=r(8847);let s=new Map,o=e=>new Date(e).toISOString().slice(0,10);async function u(e){let t=`ext-${e}`,r=Date.now(),a=s.get(t);if(a&&a.expires>r)return a.data;let n=function(e){let t=e=>process.env[e]?.trim();return"C1"===e?[t("C1_ICAL_AIRBNB"),t("C1_ICAL_BOOKING"),t("C1_ICAL_ABRITEL")].filter(Boolean):"C2"===e?[t("C2_ICAL_AIRBNB"),t("C2_ICAL_BOOKING"),t("C2_ICAL_ABRITEL")].filter(Boolean):[]}(e),u=[];for(let e of n)try{let t=await i().async.fromURL(e);for(let e in t){let r=t[e];"VEVENT"===r.type&&r.start&&r.end&&"CANCELLED"!==(r.status||"").toUpperCase()&&u.push({start:r.start,end:r.end})}}catch(e){}let l=function(e){let t=e.slice().sort((e,t)=>new Date(e.start)-new Date(t.start)),r=[];for(let e of t){if(!r.length){r.push({...e});continue}let t=r[r.length-1];new Date(e.start)<=new Date(t.end)?t.end=new Date(Math.max(+new Date(t.end),+new Date(e.end))):r.push({...e})}return r}(u),c=new Set;for(let e of l)for(let t of function(e,t){let r=new Date(e);r.setHours(12,0,0,0);let a=new Date(t);a.setHours(12,0,0,0);let i=[];for(let e=new Date(r);e<=a;e.setDate(e.getDate()+1))i.push(o(e));return i.pop(),i}(e.start,e.end))c.add(t);let d={chalet:e,ranges:l.map(e=>({start:o(e.start),end:o(e.end)})),bookedDates:[...c].sort(),updatedAt:new Date().toISOString()};return s.set(t,{expires:r+9e5,data:d}),d}async function l(e){let t=(e||"").toUpperCase(),r=(await (0,n.KQ)()).filter(e=>{let r=(e.chalet||"").toUpperCase(),a=(e.status||"confirmed").toLowerCase();return r===t&&"cancelled"!==a}).map(e=>({id:e.id,checkIn:e.ci,checkOut:e.co,name:e.name||"",status:e.status||"confirmed"}));return console.log("[loadSiteReservations]",t,"->",r.length,"r\xe9servations trouv\xe9es"),r}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,972,749,934],()=>r(8919));module.exports=a})();