(()=>{var t={};t.id=915,t.ids=[915],t.modules={399:t=>{"use strict";t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{"use strict";t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:t=>{"use strict";t.exports=require("assert")},6113:t=>{"use strict";t.exports=require("crypto")},2361:t=>{"use strict";t.exports=require("events")},7147:t=>{"use strict";t.exports=require("fs")},3292:t=>{"use strict";t.exports=require("fs/promises")},3685:t=>{"use strict";t.exports=require("http")},5687:t=>{"use strict";t.exports=require("https")},6005:t=>{"use strict";t.exports=require("node:crypto")},1017:t=>{"use strict";t.exports=require("path")},2781:t=>{"use strict";t.exports=require("stream")},7310:t=>{"use strict";t.exports=require("url")},3837:t=>{"use strict";t.exports=require("util")},9796:t=>{"use strict";t.exports=require("zlib")},1825:()=>{},3207:(t,e,r)=>{"use strict";r.r(e),r.d(e,{originalPathname:()=>D,patchFetch:()=>y,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>C,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>d,dynamic:()=>c});var i=r(9303),n=r(8716),s=r(670),o=r(7070),u=r(7904);let c="force-dynamic",l=t=>(t||"").replace(/([,;])/g,"\\$1").replace(/\n/g,"\\n"),p=t=>{let e=new Date(t),r=e.getUTCFullYear(),a=String(e.getUTCMonth()+1).padStart(2,"0"),i=String(e.getUTCDate()).padStart(2,"0");return`${r}${a}${i}`};async function d(t,{params:e}){let r=(e&&e.chalet?e.chalet:"C1").toUpperCase(),a=await (0,u.o)(r),i=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Ty-Koad//iCal Export//FR","CALSCALE:GREGORIAN","METHOD:PUBLISH"];for(let t of a){let e=`site-${r}-${t.id||`${t.checkIn}-${t.checkOut}`}`,a=new Date().toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";i.push("BEGIN:VEVENT",`UID:${e}`,`DTSTAMP:${a}`,`DTSTART;VALUE=DATE:${p(t.checkIn)}`,`DTEND;VALUE=DATE:${p(t.checkOut)}`,`SUMMARY:${l(t.name||"R\xe9serv\xe9 sur le site")}`,"END:VEVENT")}return i.push("END:VCALENDAR"),new o.NextResponse(i.join("\r\n"),{status:200,headers:{"Content-Type":"text/calendar; charset=utf-8","Content-Disposition":`attachment; filename="ty-koad-${r.toLowerCase()}.ics"`}})}let f=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/ical/[chalet]/route",pathname:"/api/ical/[chalet]",filename:"route",bundlePath:"app/api/ical/[chalet]/route"},resolvedPagePath:"C:\\Users\\Nina\\Downloads\\ty-koad-v5_1\\ty-koad-demo-v5.1\\app\\api\\ical\\[chalet]\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:C}=f,D="/api/ical/[chalet]/route";function y(){return(0,s.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:h})}},8847:(t,e,r)=>{"use strict";r.d(e,{$:()=>g,KQ:()=>d,bA:()=>w,iD:()=>f,iE:()=>h,k3:()=>A,v6:()=>C});var a=r(3292),i=r.n(a),n=r(1017),s=r.n(n);let o=s().join(process.cwd(),"data"),u=s().join(o,"reservations.json"),c=s().join(o,"config.json"),l=s().join(o,"vouchers.json");async function p(){await i().mkdir(o,{recursive:!0});try{await i().access(u)}catch{await i().writeFile(u,"[]","utf-8")}try{await i().access(c)}catch{await i().writeFile(c,JSON.stringify({icalC1:"",icalC2:""},null,2),"utf-8")}try{await i().access(l)}catch{await i().writeFile(l,"[]","utf-8")}}async function d(){return await p(),JSON.parse(await i().readFile(u,"utf-8")||"[]")}async function f(t){await p();let e=await d();return e.unshift({...t,createdAt:new Date().toISOString()}),await i().writeFile(u,JSON.stringify(e,null,2),"utf-8"),{ok:!0}}async function w({paymentIntentId:t,...e}){await p();let r=await d(),a=r.findIndex(e=>e.paymentIntentId===t);return a>=0&&(r[a]={...r[a],...e}),await i().writeFile(u,JSON.stringify(r,null,2),"utf-8"),{ok:!0}}async function h(){return await p(),JSON.parse(await i().readFile(c,"utf-8")||"{}")}async function C(t){let e={...await h(),...t};return await i().writeFile(c,JSON.stringify(e,null,2),"utf-8"),e}let D=async()=>(await p(),JSON.parse(await i().readFile(l,"utf-8")||"[]")),y=async t=>i().writeFile(l,JSON.stringify(t,null,2),"utf-8");async function g(t){let e=await D();if(e.some(e=>e.code===t.code))throw Error("Code d\xe9j\xe0 existant");return e.unshift({...t,createdAt:new Date().toISOString(),status:"active",redemptions:[]}),await y(e),t}async function A(t){return(await D()).find(e=>e.stripeSessionId===t)||null}},7904:(t,e,r)=>{"use strict";r.d(e,{Y:()=>u,o:()=>c});var a=r(3934),i=r.n(a),n=r(8847);let s=new Map,o=t=>new Date(t).toISOString().slice(0,10);async function u(t){let e=`ext-${t}`,r=Date.now(),a=s.get(e);if(a&&a.expires>r)return a.data;let n=function(t){let e=t=>process.env[t]?.trim();return"C1"===t?[e("C1_ICAL_AIRBNB"),e("C1_ICAL_BOOKING"),e("C1_ICAL_ABRITEL")].filter(Boolean):"C2"===t?[e("C2_ICAL_AIRBNB"),e("C2_ICAL_BOOKING"),e("C2_ICAL_ABRITEL")].filter(Boolean):[]}(t),u=[];for(let t of n)try{let e=await i().async.fromURL(t);for(let t in e){let r=e[t];"VEVENT"===r.type&&r.start&&r.end&&"CANCELLED"!==(r.status||"").toUpperCase()&&u.push({start:r.start,end:r.end})}}catch(t){}let c=function(t){let e=t.slice().sort((t,e)=>new Date(t.start)-new Date(e.start)),r=[];for(let t of e){if(!r.length){r.push({...t});continue}let e=r[r.length-1];new Date(t.start)<=new Date(e.end)?e.end=new Date(Math.max(+new Date(e.end),+new Date(t.end))):r.push({...t})}return r}(u),l=new Set;for(let t of c)for(let e of function(t,e){let r=new Date(t);r.setHours(12,0,0,0);let a=new Date(e);a.setHours(12,0,0,0);let i=[];for(let t=new Date(r);t<=a;t.setDate(t.getDate()+1))i.push(o(t));return i.pop(),i}(t.start,t.end))l.add(e);let p={chalet:t,ranges:c.map(t=>({start:o(t.start),end:o(t.end)})),bookedDates:[...l].sort(),updatedAt:new Date().toISOString()};return s.set(e,{expires:r+9e5,data:p}),p}async function c(t){let e=(t||"").toUpperCase(),r=(await (0,n.KQ)()).filter(t=>{let r=(t.chalet||"").toUpperCase(),a=(t.status||"confirmed").toLowerCase();return r===e&&"cancelled"!==a}).map(t=>({id:t.id,checkIn:t.ci,checkOut:t.co,name:t.name||"",status:t.status||"confirmed"}));return console.log("[loadSiteReservations]",e,"->",r.length,"r\xe9servations trouv\xe9es"),r}}};var e=require("../../../../webpack-runtime.js");e.C(t);var r=t=>e(e.s=t),a=e.X(0,[948,972,749,934],()=>r(3207));module.exports=a})();