(()=>{var e={};e.id=324,e.ids=[324],e.modules={399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3292:e=>{"use strict";e.exports=require("fs/promises")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},6005:e=>{"use strict";e.exports=require("node:crypto")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},1825:()=>{},7869:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>y,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var a={};r.r(a),r.d(a,{GET:()=>l,dynamic:()=>c});var s=r(9303),n=r(8716),i=r(670),o=r(7070),u=r(7904);let c="force-dynamic";async function l(e,{params:t}){let r=(t?.chalet||"").toUpperCase();if(!r)return o.NextResponse.json({error:"chalet requis"},{status:400});try{let e=await (0,u.Y)(r),t=await (0,u.o)(r),a=new Set;for(let e of t){let t=new Date(e.checkIn);t.setHours(12,0,0,0);let r=new Date(e.checkOut);r.setHours(12,0,0,0);for(let e=new Date(t);e<r;e.setDate(e.getDate()+1))a.add(function(e){let t=new Date(e);return t.setHours(12,0,0,0),t.toISOString().slice(0,10)}(e))}let s=new Set(e.bookedDates||[]);for(let e of a)s.add(e);return o.NextResponse.json({chalet:r,blocked:Array.from(s).sort(),updatedAt:e.updatedAt})}catch(e){return console.error(e),o.NextResponse.json({error:"Erreur iCal"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/ical/blocked/[chalet]/route",pathname:"/api/ical/blocked/[chalet]",filename:"route",bundlePath:"app/api/ical/blocked/[chalet]/route"},resolvedPagePath:"C:\\Users\\Nina\\Downloads\\ty-koad-v5_1\\ty-koad-demo-v5.1\\app\\api\\ical\\blocked\\[chalet]\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:f,serverHooks:w}=d,h="/api/ical/blocked/[chalet]/route";function y(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},8847:(e,t,r)=>{"use strict";r.d(t,{$:()=>C,KQ:()=>p,bA:()=>w,iD:()=>f,iE:()=>h,k3:()=>D,v6:()=>y});var a=r(3292),s=r.n(a),n=r(1017),i=r.n(n);let o=i().join(process.cwd(),"data"),u=i().join(o,"reservations.json"),c=i().join(o,"config.json"),l=i().join(o,"vouchers.json");async function d(){await s().mkdir(o,{recursive:!0});try{await s().access(u)}catch{await s().writeFile(u,"[]","utf-8")}try{await s().access(c)}catch{await s().writeFile(c,JSON.stringify({icalC1:"",icalC2:""},null,2),"utf-8")}try{await s().access(l)}catch{await s().writeFile(l,"[]","utf-8")}}async function p(){return await d(),JSON.parse(await s().readFile(u,"utf-8")||"[]")}async function f(e){await d();let t=await p();return t.unshift({...e,createdAt:new Date().toISOString()}),await s().writeFile(u,JSON.stringify(t,null,2),"utf-8"),{ok:!0}}async function w({paymentIntentId:e,...t}){await d();let r=await p(),a=r.findIndex(t=>t.paymentIntentId===e);return a>=0&&(r[a]={...r[a],...t}),await s().writeFile(u,JSON.stringify(r,null,2),"utf-8"),{ok:!0}}async function h(){return await d(),JSON.parse(await s().readFile(c,"utf-8")||"{}")}async function y(e){let t={...await h(),...e};return await s().writeFile(c,JSON.stringify(t,null,2),"utf-8"),t}let x=async()=>(await d(),JSON.parse(await s().readFile(l,"utf-8")||"[]")),m=async e=>s().writeFile(l,JSON.stringify(e,null,2),"utf-8");async function C(e){let t=await x();if(t.some(t=>t.code===e.code))throw Error("Code d\xe9j\xe0 existant");return t.unshift({...e,createdAt:new Date().toISOString(),status:"active",redemptions:[]}),await m(t),e}async function D(e){return(await x()).find(t=>t.stripeSessionId===e)||null}},7904:(e,t,r)=>{"use strict";r.d(t,{Y:()=>u,o:()=>c});var a=r(3934),s=r.n(a),n=r(8847);let i=new Map,o=e=>new Date(e).toISOString().slice(0,10);async function u(e){let t=`ext-${e}`,r=Date.now(),a=i.get(t);if(a&&a.expires>r)return a.data;let n=function(e){let t=e=>process.env[e]?.trim();return"C1"===e?[t("C1_ICAL_AIRBNB"),t("C1_ICAL_BOOKING"),t("C1_ICAL_ABRITEL")].filter(Boolean):"C2"===e?[t("C2_ICAL_AIRBNB"),t("C2_ICAL_BOOKING"),t("C2_ICAL_ABRITEL")].filter(Boolean):[]}(e),u=[];for(let e of n)try{let t=await s().async.fromURL(e);for(let e in t){let r=t[e];"VEVENT"===r.type&&r.start&&r.end&&"CANCELLED"!==(r.status||"").toUpperCase()&&u.push({start:r.start,end:r.end})}}catch(e){}let c=function(e){let t=e.slice().sort((e,t)=>new Date(e.start)-new Date(t.start)),r=[];for(let e of t){if(!r.length){r.push({...e});continue}let t=r[r.length-1];new Date(e.start)<=new Date(t.end)?t.end=new Date(Math.max(+new Date(t.end),+new Date(e.end))):r.push({...e})}return r}(u),l=new Set;for(let e of c)for(let t of function(e,t){let r=new Date(e);r.setHours(12,0,0,0);let a=new Date(t);a.setHours(12,0,0,0);let s=[];for(let e=new Date(r);e<=a;e.setDate(e.getDate()+1))s.push(o(e));return s.pop(),s}(e.start,e.end))l.add(t);let d={chalet:e,ranges:c.map(e=>({start:o(e.start),end:o(e.end)})),bookedDates:[...l].sort(),updatedAt:new Date().toISOString()};return i.set(t,{expires:r+9e5,data:d}),d}async function c(e){let t=(e||"").toUpperCase(),r=(await (0,n.KQ)()).filter(e=>{let r=(e.chalet||"").toUpperCase(),a=(e.status||"confirmed").toLowerCase();return r===t&&"cancelled"!==a}).map(e=>({id:e.id,checkIn:e.ci,checkOut:e.co,name:e.name||"",status:e.status||"confirmed"}));return console.log("[loadSiteReservations]",t,"->",r.length,"r\xe9servations trouv\xe9es"),r}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,972,749,934],()=>r(7869));module.exports=a})();