(()=>{var e={};e.id=977,e.ids=[977],e.modules={399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9491:e=>{"use strict";e.exports=require("assert")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3292:e=>{"use strict";e.exports=require("fs/promises")},3685:e=>{"use strict";e.exports=require("http")},5687:e=>{"use strict";e.exports=require("https")},6005:e=>{"use strict";e.exports=require("node:crypto")},1017:e=>{"use strict";e.exports=require("path")},2781:e=>{"use strict";e.exports=require("stream")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},1825:()=>{},3667:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>D,patchFetch:()=>y,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>C,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>d,dynamic:()=>c});var i=r(9303),n=r(8716),s=r(670),o=r(7070),u=r(7904);let c="force-dynamic",l=e=>(e||"").replace(/([,;])/g,"\\$1").replace(/\n/g,"\\n"),p=e=>{let t=new Date(e);return`${t.getUTCFullYear()}${String(t.getUTCMonth()+1).padStart(2,"0")}${String(t.getUTCDate()).padStart(2,"0")}`};async function d(e){let{searchParams:t}=new URL(e.url),r=(t.get("chalet")||"C1").toUpperCase(),a=await (0,u.o)(r),i=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Ty-Koad//Unified iCal//FR","CALSCALE:GREGORIAN","METHOD:PUBLISH"];for(let e of a){let t=`site-${r}-${e.id||`${e.checkIn}-${e.checkOut}`}`,a=new Date().toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";i.push("BEGIN:VEVENT",`UID:${t}`,`DTSTAMP:${a}`,`DTSTART;VALUE=DATE:${p(e.checkIn)}`,`DTEND;VALUE=DATE:${p(e.checkOut)}`,`SUMMARY:${l(e.name||"R\xe9serv\xe9 sur le site")}`,"END:VEVENT")}return i.push("END:VCALENDAR"),new o.NextResponse(i.join("\r\n"),{status:200,headers:{"Content-Type":"text/calendar; charset=utf-8","Content-Disposition":`attachment; filename="ty-koad-${r.toLowerCase()}.ics"`}})}let f=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/ical/export/route",pathname:"/api/ical/export",filename:"route",bundlePath:"app/api/ical/export/route"},resolvedPagePath:"C:\\Users\\Nina\\Downloads\\ty-koad-v5_1\\ty-koad-demo-v5.1\\app\\api\\ical\\export\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:C}=f,D="/api/ical/export/route";function y(){return(0,s.patchFetch)({serverHooks:C,staticGenerationAsyncStorage:h})}},8847:(e,t,r)=>{"use strict";r.d(t,{$:()=>x,KQ:()=>d,bA:()=>w,iD:()=>f,iE:()=>h,k3:()=>g,v6:()=>C});var a=r(3292),i=r.n(a),n=r(1017),s=r.n(n);let o=s().join(process.cwd(),"data"),u=s().join(o,"reservations.json"),c=s().join(o,"config.json"),l=s().join(o,"vouchers.json");async function p(){await i().mkdir(o,{recursive:!0});try{await i().access(u)}catch{await i().writeFile(u,"[]","utf-8")}try{await i().access(c)}catch{await i().writeFile(c,JSON.stringify({icalC1:"",icalC2:""},null,2),"utf-8")}try{await i().access(l)}catch{await i().writeFile(l,"[]","utf-8")}}async function d(){return await p(),JSON.parse(await i().readFile(u,"utf-8")||"[]")}async function f(e){await p();let t=await d();return t.unshift({...e,createdAt:new Date().toISOString()}),await i().writeFile(u,JSON.stringify(t,null,2),"utf-8"),{ok:!0}}async function w({paymentIntentId:e,...t}){await p();let r=await d(),a=r.findIndex(t=>t.paymentIntentId===e);return a>=0&&(r[a]={...r[a],...t}),await i().writeFile(u,JSON.stringify(r,null,2),"utf-8"),{ok:!0}}async function h(){return await p(),JSON.parse(await i().readFile(c,"utf-8")||"{}")}async function C(e){let t={...await h(),...e};return await i().writeFile(c,JSON.stringify(t,null,2),"utf-8"),t}let D=async()=>(await p(),JSON.parse(await i().readFile(l,"utf-8")||"[]")),y=async e=>i().writeFile(l,JSON.stringify(e,null,2),"utf-8");async function x(e){let t=await D();if(t.some(t=>t.code===e.code))throw Error("Code d\xe9j\xe0 existant");return t.unshift({...e,createdAt:new Date().toISOString(),status:"active",redemptions:[]}),await y(t),e}async function g(e){return(await D()).find(t=>t.stripeSessionId===e)||null}},7904:(e,t,r)=>{"use strict";r.d(t,{Y:()=>u,o:()=>c});var a=r(3934),i=r.n(a),n=r(8847);let s=new Map,o=e=>new Date(e).toISOString().slice(0,10);async function u(e){let t=`ext-${e}`,r=Date.now(),a=s.get(t);if(a&&a.expires>r)return a.data;let n=function(e){let t=e=>process.env[e]?.trim();return"C1"===e?[t("C1_ICAL_AIRBNB"),t("C1_ICAL_BOOKING"),t("C1_ICAL_ABRITEL")].filter(Boolean):"C2"===e?[t("C2_ICAL_AIRBNB"),t("C2_ICAL_BOOKING"),t("C2_ICAL_ABRITEL")].filter(Boolean):[]}(e),u=[];for(let e of n)try{let t=await i().async.fromURL(e);for(let e in t){let r=t[e];"VEVENT"===r.type&&r.start&&r.end&&"CANCELLED"!==(r.status||"").toUpperCase()&&u.push({start:r.start,end:r.end})}}catch(e){}let c=function(e){let t=e.slice().sort((e,t)=>new Date(e.start)-new Date(t.start)),r=[];for(let e of t){if(!r.length){r.push({...e});continue}let t=r[r.length-1];new Date(e.start)<=new Date(t.end)?t.end=new Date(Math.max(+new Date(t.end),+new Date(e.end))):r.push({...e})}return r}(u),l=new Set;for(let e of c)for(let t of function(e,t){let r=new Date(e);r.setHours(12,0,0,0);let a=new Date(t);a.setHours(12,0,0,0);let i=[];for(let e=new Date(r);e<=a;e.setDate(e.getDate()+1))i.push(o(e));return i.pop(),i}(e.start,e.end))l.add(t);let p={chalet:e,ranges:c.map(e=>({start:o(e.start),end:o(e.end)})),bookedDates:[...l].sort(),updatedAt:new Date().toISOString()};return s.set(t,{expires:r+9e5,data:p}),p}async function c(e){let t=(e||"").toUpperCase(),r=(await (0,n.KQ)()).filter(e=>{let r=(e.chalet||"").toUpperCase(),a=(e.status||"confirmed").toLowerCase();return r===t&&"cancelled"!==a}).map(e=>({id:e.id,checkIn:e.ci,checkOut:e.co,name:e.name||"",status:e.status||"confirmed"}));return console.log("[loadSiteReservations]",t,"->",r.length,"r\xe9servations trouv\xe9es"),r}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[948,972,749,934],()=>r(3667));module.exports=a})();