"use strict";(()=>{var e={};e.id=770,e.ids=[770],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},687:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>y,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var n={};r.r(n),r.d(n,{POST:()=>f});var s=r(9303),i=r(8716),a=r(670),o=r(7194);let u={C1:{base:7e3},C2:{week:13e3,weekend:15e3}};function l(e,t){if(!e||!t)return 0;let r=new Date(e),n=new Date(t);return r.setHours(12,0,0,0),n.setHours(12,0,0,0),Math.max(0,Math.round((n-r)/864e5))}function*p(e,t){let r=new Date(e);for(let e=0;e<t;e++){let t=new Date(r);t.setDate(r.getDate()+e),yield t}}async function f(e){try{let{code:t,chalet:r,checkIn:n,checkOut:s}=await e.json();if(!t||!r||!n||!s)return new Response(JSON.stringify({error:"Param\xe8tres manquants"}),{status:400});let i=await o.Z.gift.findUnique({where:{code:t}});if(!i)return new Response(JSON.stringify({error:"Code introuvable"}),{status:404});if(i.usedAt)return new Response(JSON.stringify({error:"Ce code a d\xe9j\xe0 \xe9t\xe9 utilis\xe9"}),{status:400});if(i.chalet!==r)return new Response(JSON.stringify({error:"Code non valable pour ce chalet"}),{status:400});if(i.expiresAt&&new Date(i.expiresAt)<new Date)return new Response(JSON.stringify({error:"Code expir\xe9"}),{status:400});let a=l(n,s);if(0===a)return new Response(JSON.stringify({error:"S\xe9lectionne tes dates"}),{status:400});let f=i.planKey;if("c2_week"===f&&!function(e,t){for(let r of p(e,t)){let e=r.getDay();if(e>=0&&e<=4)return!0}return!1}(n,a))return new Response(JSON.stringify({error:"Ce bon est valable sur une nuit en semaine (dim-jeu)"}),{status:400});if("c2_weekend"===f&&!function(e,t){for(let r of p(e,t)){let e=r.getDay();if(5===e||6===e)return!0}return!1}(n,a))return new Response(JSON.stringify({error:"Ce bon est valable sur une nuit de week-end (ven-sam)"}),{status:400});if(f.startsWith("c1_")){let e=Number(f.split("_")[1].replace("n",""));if(a<e)return new Response(JSON.stringify({error:`Ce bon requiert au moins ${e} nuits`}),{status:400})}let d=function(e,t,r){let n=l(t,r);if(0===n)return 0;if("C1"===e)return u.C1.base*n;{let e=0;for(let r of p(t,n)){let t=r.getDay();e+=5===t||6===t?u.C2.weekend:u.C2.week}return e}}(r,n,s),c=Math.min(d,i.amountCents);return new Response(JSON.stringify({ok:!0,valueCents:c,bookingCents:d,remainingCents:Math.max(0,i.amountCents-c),message:`Bon appliqu\xe9 (âˆ’ ${(c/100).toLocaleString("fr-FR",{style:"currency",currency:"EUR"})})`}),{status:200})}catch(e){return console.error(e),new Response(JSON.stringify({error:e.message}),{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/gift/redeem/route",pathname:"/api/gift/redeem",filename:"route",bundlePath:"app/api/gift/redeem/route"},resolvedPagePath:"C:\\Users\\Nina\\Downloads\\ty-koad-v5_1\\ty-koad-demo-v5.1\\app\\api\\gift\\redeem\\route.js",nextConfigOutput:"",userland:n}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:g}=d,w="/api/gift/redeem/route";function y(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},7194:(e,t,r)=>{r.d(t,{Z:()=>a});let n=require("@prisma/client"),s=globalThis,i=s.__prisma__??new n.PrismaClient;s.__prisma__||(s.__prisma__=i);let a=i},9303:(e,t,r)=>{e.exports=r(517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948],()=>r(687));module.exports=n})();