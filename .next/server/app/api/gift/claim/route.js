"use strict";(()=>{var e={};e.id=714,e.ids=[714],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},3837:e=>{e.exports=require("util")},8152:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>C,patchFetch:()=>I,requestAsyncStorage:()=>O,routeModule:()=>A,serverHooks:()=>k,staticGenerationAsyncStorage:()=>j});var n={};r.r(n),r.d(n,{POST:()=>q});var s=r(9303),i=r(8716),a=r(670),o=r(3114),l=Object.defineProperty,u=Object.defineProperties,c=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,h=Object.prototype.hasOwnProperty,m=Object.prototype.propertyIsEnumerable,p=(e,t,r)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,f=(e,t)=>{for(var r in t||(t={}))h.call(t,r)&&p(e,r,t[r]);if(d)for(var r of d(t))m.call(t,r)&&p(e,r,t[r]);return e},y=(e,t)=>u(e,c(t)),g=(e,t,r)=>new Promise((n,s)=>{var i=e=>{try{o(r.next(e))}catch(e){s(e)}},a=e=>{try{o(r.throw(e))}catch(e){s(e)}},o=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,a);o((r=r.apply(e,t)).next())}),b=class{constructor(e){this.resend=e}create(e){return g(this,arguments,function*(e,t={}){return yield this.resend.post("/api-keys",e,t)})}list(){return g(this,null,function*(){return yield this.resend.get("/api-keys")})}remove(e){return g(this,null,function*(){return yield this.resend.delete(`/api-keys/${e}`)})}},_=class{constructor(e){this.resend=e}create(e){return g(this,arguments,function*(e,t={}){return yield this.resend.post("/audiences",e,t)})}list(){return g(this,null,function*(){return yield this.resend.get("/audiences")})}get(e){return g(this,null,function*(){return yield this.resend.get(`/audiences/${e}`)})}remove(e){return g(this,null,function*(){return yield this.resend.delete(`/audiences/${e}`)})}};function v(e){var t;return{attachments:null==(t=e.attachments)?void 0:t.map(e=>({content:e.content,filename:e.filename,path:e.path,content_type:e.contentType,content_id:e.contentId})),bcc:e.bcc,cc:e.cc,from:e.from,headers:e.headers,html:e.html,reply_to:e.replyTo,scheduled_at:e.scheduledAt,subject:e.subject,tags:e.tags,text:e.text,to:e.to}}var w=class{constructor(e){this.resend=e}send(e){return g(this,arguments,function*(e,t={}){return this.create(e,t)})}create(e){return g(this,arguments,function*(e,t={}){let n=[];for(let t of e){if(t.react){if(!this.renderAsync)try{let{renderAsync:e}=yield r.e(486).then(r.t.bind(r,5486,19));this.renderAsync=e}catch(e){throw Error("Failed to render React component. Make sure to install `@react-email/render`")}t.html=yield this.renderAsync(t.react),t.react=void 0}n.push(v(t))}return yield this.resend.post("/emails/batch",n,t)})}},x=class{constructor(e){this.resend=e}create(e){return g(this,arguments,function*(e,t={}){if(e.react){if(!this.renderAsync)try{let{renderAsync:e}=yield r.e(486).then(r.t.bind(r,5486,19));this.renderAsync=e}catch(e){throw Error("Failed to render React component. Make sure to install `@react-email/render`")}e.html=yield this.renderAsync(e.react)}return yield this.resend.post("/broadcasts",{name:e.name,audience_id:e.audienceId,preview_text:e.previewText,from:e.from,html:e.html,reply_to:e.replyTo,subject:e.subject,text:e.text},t)})}send(e,t){return g(this,null,function*(){return yield this.resend.post(`/broadcasts/${e}/send`,{scheduled_at:null==t?void 0:t.scheduledAt})})}list(){return g(this,null,function*(){return yield this.resend.get("/broadcasts")})}get(e){return g(this,null,function*(){return yield this.resend.get(`/broadcasts/${e}`)})}remove(e){return g(this,null,function*(){return yield this.resend.delete(`/broadcasts/${e}`)})}update(e,t){return g(this,null,function*(){return yield this.resend.patch(`/broadcasts/${e}`,{name:t.name,audience_id:t.audienceId,from:t.from,html:t.html,text:t.text,subject:t.subject,reply_to:t.replyTo,preview_text:t.previewText})})}},E=class{constructor(e){this.resend=e}create(e){return g(this,arguments,function*(e,t={}){return yield this.resend.post(`/audiences/${e.audienceId}/contacts`,{unsubscribed:e.unsubscribed,email:e.email,first_name:e.firstName,last_name:e.lastName},t)})}list(e){return g(this,null,function*(){return yield this.resend.get(`/audiences/${e.audienceId}/contacts`)})}get(e){return g(this,null,function*(){return e.id||e.email?yield this.resend.get(`/audiences/${e.audienceId}/contacts/${(null==e?void 0:e.email)?null==e?void 0:e.email:null==e?void 0:e.id}`):{data:null,error:{message:"Missing `id` or `email` field.",name:"missing_required_field"}}})}update(e){return g(this,null,function*(){return e.id||e.email?yield this.resend.patch(`/audiences/${e.audienceId}/contacts/${(null==e?void 0:e.email)?null==e?void 0:e.email:null==e?void 0:e.id}`,{unsubscribed:e.unsubscribed,first_name:e.firstName,last_name:e.lastName}):{data:null,error:{message:"Missing `id` or `email` field.",name:"missing_required_field"}}})}remove(e){return g(this,null,function*(){return e.id||e.email?yield this.resend.delete(`/audiences/${e.audienceId}/contacts/${(null==e?void 0:e.email)?null==e?void 0:e.email:null==e?void 0:e.id}`):{data:null,error:{message:"Missing `id` or `email` field.",name:"missing_required_field"}}})}},P=class{constructor(e){this.resend=e}create(e){return g(this,arguments,function*(e,t={}){return yield this.resend.post("/domains",{name:e.name,region:e.region,custom_return_path:e.customReturnPath},t)})}list(){return g(this,null,function*(){return yield this.resend.get("/domains")})}get(e){return g(this,null,function*(){return yield this.resend.get(`/domains/${e}`)})}update(e){return g(this,null,function*(){return yield this.resend.patch(`/domains/${e.id}`,{click_tracking:e.clickTracking,open_tracking:e.openTracking,tls:e.tls})})}remove(e){return g(this,null,function*(){return yield this.resend.delete(`/domains/${e}`)})}verify(e){return g(this,null,function*(){return yield this.resend.post(`/domains/${e}/verify`)})}},S=class{constructor(e){this.resend=e}send(e){return g(this,arguments,function*(e,t={}){return this.create(e,t)})}create(e){return g(this,arguments,function*(e,t={}){if(e.react){if(!this.renderAsync)try{let{renderAsync:e}=yield r.e(486).then(r.t.bind(r,5486,19));this.renderAsync=e}catch(e){throw Error("Failed to render React component. Make sure to install `@react-email/render`")}e.html=yield this.renderAsync(e.react)}return yield this.resend.post("/emails",v(e),t)})}get(e){return g(this,null,function*(){return yield this.resend.get(`/emails/${e}`)})}update(e){return g(this,null,function*(){return yield this.resend.patch(`/emails/${e.id}`,{scheduled_at:e.scheduledAt})})}cancel(e){return g(this,null,function*(){return yield this.resend.post(`/emails/${e}/cancel`)})}},$="undefined"!=typeof process&&process.env&&process.env.RESEND_BASE_URL||"https://api.resend.com",R="undefined"!=typeof process&&process.env&&process.env.RESEND_USER_AGENT||"resend-node:6.0.2",N=class{constructor(e){if(this.key=e,this.apiKeys=new b(this),this.audiences=new _(this),this.batch=new w(this),this.broadcasts=new x(this),this.contacts=new E(this),this.domains=new P(this),this.emails=new S(this),!e&&("undefined"!=typeof process&&process.env&&(this.key=process.env.RESEND_API_KEY),!this.key))throw Error('Missing API key. Pass it to the constructor `new Resend("re_123")`');this.headers=new Headers({Authorization:`Bearer ${this.key}`,"User-Agent":R,"Content-Type":"application/json"})}fetchRequest(e){return g(this,arguments,function*(e,t={}){try{let r=yield fetch(`${$}${e}`,t);if(!r.ok)try{let e=yield r.text();return{data:null,error:JSON.parse(e)}}catch(t){if(t instanceof SyntaxError)return{data:null,error:{name:"application_error",message:"Internal server error. We are unable to process your request right now, please try again later."}};let e={message:r.statusText,name:"application_error"};if(t instanceof Error)return{data:null,error:y(f({},e),{message:t.message})};return{data:null,error:e}}return{data:yield r.json(),error:null}}catch(e){return{data:null,error:{name:"application_error",message:"Unable to fetch data. The request could not be resolved."}}}})}post(e,t){return g(this,arguments,function*(e,t,r={}){let n=new Headers(this.headers);r.idempotencyKey&&n.set("Idempotency-Key",r.idempotencyKey);let s=f({method:"POST",headers:n,body:JSON.stringify(t)},r);return this.fetchRequest(e,s)})}get(e){return g(this,arguments,function*(e,t={}){let r=f({method:"GET",headers:this.headers},t);return this.fetchRequest(e,r)})}put(e,t){return g(this,arguments,function*(e,t,r={}){let n=f({method:"PUT",headers:this.headers,body:JSON.stringify(t)},r);return this.fetchRequest(e,n)})}patch(e,t){return g(this,arguments,function*(e,t,r={}){let n=f({method:"PATCH",headers:this.headers,body:JSON.stringify(t)},r);return this.fetchRequest(e,n)})}delete(e,t){return g(this,null,function*(){let r={method:"DELETE",headers:this.headers,body:JSON.stringify(t)};return this.fetchRequest(e,r)})}},T=r(7194);async function q(e){try{let{session_id:t}=await e.json();if(!t)return new Response(JSON.stringify({error:"session_id manquant"}),{status:400});let r=new o.Z(process.env.STRIPE_SECRET_KEY),n=await r.checkout.sessions.retrieve(t,{expand:["line_items"]});if("paid"!==n.payment_status)return new Response(JSON.stringify({error:"Paiement non confirm\xe9"}),{status:400});let s=n.metadata||{},i=n.amount_total||0,a="C2"===s.chalet?"Ty-Koad Duo (spa privatif)":"Ty-Koad — 2 chambres / 2 SDB",l=n.line_items?.data?.[0],u=l?.description||"S\xe9jour",c=(s.extrasCSV||"").split(",").filter(Boolean).map(e=>e.trim()).map(e=>"fruits"===e?"Plateau fruits de mer":"champagne"===e?"Champagne":"petales"===e?"P\xe9tales de rose":"charcuterie"===e?"Plateau charcuterie":"petitdej2"===e?"Petit d\xe9jeuner (2 pers.)":e).join(", "),d=(s.fromName+"-"+s.toName+"-"+new Date().toISOString().slice(0,10)).toUpperCase(),h=0;for(let e=0;e<d.length;e++)h=31*h+d.charCodeAt(e)>>>0;let m=(h.toString(36).toUpperCase()+"0000").slice(0,8),p=`TKO-${m.slice(0,4)}-${m.slice(4,8)}`;await T.Z.gift.upsert({where:{code:p},update:{},create:{code:p,chalet:s.chalet,planKey:s.planKey,amountCents:i,extrasCSV:c,fromName:s.fromName||"",toName:s.toName||"",buyerEmail:s.buyerEmail||null,toEmail:s.toEmail||null,message:s.message||null}});let f=process.env.SITE_URL||"http://localhost:3000",y=new URL(`${f}/api/gift/pdf`);y.searchParams.set("code",p),y.searchParams.set("chaletLabel",a),y.searchParams.set("planLabel",u),y.searchParams.set("amountCents",String(i)),y.searchParams.set("fromName",s.fromName||""),y.searchParams.set("toName",s.toName||""),y.searchParams.set("message",s.message||""),y.searchParams.set("extrasCSV",c);let g=new N(process.env.RESEND_API_KEY),b=[s.buyerEmail,s.toEmail].filter(Boolean),_=`
      <div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5">
        <h2>Merci pour votre achat – Ch\xe8que cadeau Ty-Koad</h2>
        <p><b>Code :</b> ${p}</p>
        <p><b>Chalet :</b> ${a}<br/>
           <b>S\xe9jour :</b> ${u}<br/>
           <b>Montant :</b> ${(i/100).toLocaleString("fr-FR",{style:"currency",currency:"EUR"})}<br/>
           ${c?`<b>Options :</b> ${c}<br/>`:""}
        </p>
        <p>➡️ <a href="${y.toString()}">T\xe9l\xe9charger le ch\xe8que cadeau (PDF)</a></p>
      </div>`;return b.length&&await g.emails.send({from:process.env.RESEND_FROM,to:b,subject:`Votre ch\xe8que cadeau Ty-Koad – code ${p}`,html:_}),new Response(JSON.stringify({ok:!0,code:p,downloadUrl:y.toString()}),{status:200})}catch(e){return console.error(e),new Response(JSON.stringify({error:e.message}),{status:500})}}let A=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/gift/claim/route",pathname:"/api/gift/claim",filename:"route",bundlePath:"app/api/gift/claim/route"},resolvedPagePath:"C:\\Users\\Nina\\Downloads\\ty-koad-v5_1\\ty-koad-demo-v5.1\\app\\api\\gift\\claim\\route.js",nextConfigOutput:"",userland:n}),{requestAsyncStorage:O,staticGenerationAsyncStorage:j,serverHooks:k}=A,C="/api/gift/claim/route";function I(){return(0,a.patchFetch)({serverHooks:k,staticGenerationAsyncStorage:j})}},7194:(e,t,r)=>{r.d(t,{Z:()=>a});let n=require("@prisma/client"),s=globalThis,i=s.__prisma__??new n.PrismaClient;s.__prisma__||(s.__prisma__=i);let a=i},9303:(e,t,r)=>{e.exports=r(517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,749,114],()=>r(8152));module.exports=n})();