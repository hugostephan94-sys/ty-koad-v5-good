"use strict";(()=>{var e={};e.id=758,e.ids=[758],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3292:e=>{e.exports=require("fs/promises")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},3837:e=>{e.exports=require("util")},4559:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>w,patchFetch:()=>h,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>d});var r={};a.r(r),a.d(r,{GET:()=>l});var i=a(9303),n=a(8716),s=a(670),o=a(3114),u=a(7070),c=a(8847);async function l(e){try{let{searchParams:t}=new URL(e.url),a=t.get("session_id");if(!a)return u.NextResponse.json({error:"session_id manquant"},{status:400});if(!process.env.STRIPE_SECRET_KEY)return u.NextResponse.json({error:"STRIPE_SECRET_KEY manquant"},{status:500});let r=await (0,c.k3)(a);if(r)return u.NextResponse.json({voucher:r});let i=new o.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-06-20"}),n=await i.checkout.sessions.retrieve(a);if("paid"!==n.payment_status)return u.NextResponse.json({error:"Paiement non confirm\xe9"},{status:400});let s=n.metadata||{},l={chalet:s.chalet||"C2",amountEUR:Number(s.amount||0),extras:JSON.parse(s.extras||"[]"),fromName:s.fromName||"",buyerEmail:s.buyerEmail||"",toName:s.toName||"",toEmail:s.toEmail||"",message:s.message||"",stripeSessionId:n.id,code:function(e=8){let t="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",a="";for(let r=0;r<e;r++)a+=t[Math.floor(Math.random()*t.length)];return a}(10)};if(await (0,c.$)(l),process.env.RESEND_API_KEY&&l.buyerEmail){let e=`${process.env.NEXT_PUBLIC_SITE_URL||"http://localhost:3000"}/api/gift/pdf/${l.code}`;try{await fetch("https://api.resend.com/emails",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${process.env.RESEND_API_KEY}`},body:JSON.stringify({from:process.env.RESEND_FROM||"Ty-Koad <onboarding@resend.dev>",to:l.toEmail?[l.buyerEmail,l.toEmail]:[l.buyerEmail],subject:"Votre ch\xe8que cadeau — Les Chalets Ty-Koad",text:`Merci ! Code: ${l.code}
Montant: ${l.amountEUR}€
Chalet: ${l.chalet}
PDF: ${e}`})})}catch(e){}}return u.NextResponse.json({voucher:l})}catch(e){return u.NextResponse.json({error:e.message},{status:400})}}let p=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/gift/fulfill/route",pathname:"/api/gift/fulfill",filename:"route",bundlePath:"app/api/gift/fulfill/route"},resolvedPagePath:"C:\\Users\\Nina\\Downloads\\ty-koad-v5_1\\ty-koad-demo-v5.1\\app\\api\\gift\\fulfill\\route.js",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:d,serverHooks:m}=p,w="/api/gift/fulfill/route";function h(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:d})}},8847:(e,t,a)=>{a.d(t,{$:()=>S,KQ:()=>f,bA:()=>m,iD:()=>d,iE:()=>w,k3:()=>g,v6:()=>h});var r=a(3292),i=a.n(r),n=a(1017),s=a.n(n);let o=s().join(process.cwd(),"data"),u=s().join(o,"reservations.json"),c=s().join(o,"config.json"),l=s().join(o,"vouchers.json");async function p(){await i().mkdir(o,{recursive:!0});try{await i().access(u)}catch{await i().writeFile(u,"[]","utf-8")}try{await i().access(c)}catch{await i().writeFile(c,JSON.stringify({icalC1:"",icalC2:""},null,2),"utf-8")}try{await i().access(l)}catch{await i().writeFile(l,"[]","utf-8")}}async function f(){return await p(),JSON.parse(await i().readFile(u,"utf-8")||"[]")}async function d(e){await p();let t=await f();return t.unshift({...e,createdAt:new Date().toISOString()}),await i().writeFile(u,JSON.stringify(t,null,2),"utf-8"),{ok:!0}}async function m({paymentIntentId:e,...t}){await p();let a=await f(),r=a.findIndex(t=>t.paymentIntentId===e);return r>=0&&(a[r]={...a[r],...t}),await i().writeFile(u,JSON.stringify(a,null,2),"utf-8"),{ok:!0}}async function w(){return await p(),JSON.parse(await i().readFile(c,"utf-8")||"{}")}async function h(e){let t={...await w(),...e};return await i().writeFile(c,JSON.stringify(t,null,2),"utf-8"),t}let y=async()=>(await p(),JSON.parse(await i().readFile(l,"utf-8")||"[]")),E=async e=>i().writeFile(l,JSON.stringify(e,null,2),"utf-8");async function S(e){let t=await y();if(t.some(t=>t.code===e.code))throw Error("Code d\xe9j\xe0 existant");return t.unshift({...e,createdAt:new Date().toISOString(),status:"active",redemptions:[]}),await E(t),e}async function g(e){return(await y()).find(t=>t.stripeSessionId===e)||null}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[948,972,749,114],()=>a(4559));module.exports=r})();